<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qatar Document OCR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .document-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 20px;
        }
        .result-container {
            padding: 20px;
            border-radius: 5px;
            background-color: #f8f9fa;
            margin-top: 20px;
        }
        .spinner-border {
            display: none;
        }
        .card {
            margin-bottom: 20px;
        }
        pre {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Qatar Document OCR</h1>
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Document (Front & Back) for OCR</h5>
                    </div>
                    <div class="card-body">
                        <div id="validationAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                            <strong>Document Validation:</strong>
                            <span id="validationMessage"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label class="form-label">Document Type Detection</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="detectionType" id="autoDetect" value="auto" checked>
                                    <label class="form-check-label" for="autoDetect">
                                        Auto Detect Document Type
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="detectionType" id="manualSelect" value="manual">
                                    <label class="form-check-label" for="manualSelect">
                                        Manually Select
                                    </label>
                                </div>
                            </div>
                            <div id="manualSelectionOptions" style="display: none;">
                                <div class="mb-3">
                                    <label for="documentType" class="form-label">Select Document Type</label>
                                    <select class="form-select" id="documentType">
                                        <option value="residency">Qatar Residency Permit (Iqama)</option>
                                        <option value="vehicle">Vehicle Registration</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="frontImage" class="form-label">Front Side Image</label>
                                <input type="file" class="form-control" id="frontImage" accept="image/*" required>
                            </div>
                            <div class="mb-3">
                                <label for="backImage" class="form-label">Back Side Image</label>
                                <input type="file" class="form-control" id="backImage" accept="image/*" required>
                            </div>
                            <div class="mb-3">
                                <label for="outputFormat" class="form-label">Output Format</label>
                                <select class="form-select" id="outputFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" id="processSpinner" role="status" aria-hidden="true"></span>
                                <span id="processButtonText">Process Document</span>
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Document Preview</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 text-center">
                                        <h6>Front Side</h6>
                                        <img id="frontPreview" class="document-preview" style="display: none;" />
                                        <p id="noFrontImageText">No front image</p>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <h6>Back Side</h6>
                                        <img id="backPreview" class="document-preview" style="display: none;" />
                                        <p id="noBackImageText">No back image</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                                            <div class="card-header">
                    <div class="d-flex justify-content-between">
                        <h5>Combined OCR Result</h5>
                        <button id="downloadButton" class="btn btn-sm btn-outline-secondary" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultInfo" style="display: none;">
                        <div class="mb-2">
                            <strong>Document Type:</strong> <span id="detectedDocType"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Processing:</strong> <span id="detectedDocSide"></span>
                        </div>
                    </div>
                                <pre id="resultContent" style="display: none;"></pre>
                                <p id="noResultText">No document processed yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const frontImage = document.getElementById('frontImage');
            const backImage = document.getElementById('backImage');
            const frontPreview = document.getElementById('frontPreview');
            const backPreview = document.getElementById('backPreview');
            const noFrontImageText = document.getElementById('noFrontImageText');
            const noBackImageText = document.getElementById('noBackImageText');
            const resultContent = document.getElementById('resultContent');
            const noResultText = document.getElementById('noResultText');
            const resultInfo = document.getElementById('resultInfo');
            const detectedDocType = document.getElementById('detectedDocType');
            const detectedDocSide = document.getElementById('detectedDocSide');
            const downloadButton = document.getElementById('downloadButton');
            const processSpinner = document.getElementById('processSpinner');
            const processButtonText = document.getElementById('processButtonText');
            const documentType = document.getElementById('documentType');
            const autoDetect = document.getElementById('autoDetect');
            const manualSelect = document.getElementById('manualSelect');
            const manualSelectionOptions = document.getElementById('manualSelectionOptions');
            const validationAlert = document.getElementById('validationAlert');
            const validationMessage = document.getElementById('validationMessage');
            
            // Handle manual vs auto detection toggle
            autoDetect.addEventListener('change', function() {
                if (this.checked) {
                    manualSelectionOptions.style.display = 'none';
                }
            });
            
            manualSelect.addEventListener('change', function() {
                if (this.checked) {
                    manualSelectionOptions.style.display = 'block';
                }
            });
            
            // Show front image preview when file is selected
            frontImage.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        frontPreview.src = e.target.result;
                        frontPreview.style.display = 'block';
                        noFrontImageText.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    frontPreview.style.display = 'none';
                    noFrontImageText.style.display = 'block';
                }
            });
            
            // Show back image preview when file is selected
            backImage.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        backPreview.src = e.target.result;
                        backPreview.style.display = 'block';
                        noBackImageText.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    backPreview.style.display = 'none';
                    noBackImageText.style.display = 'block';
                }
            });
            
            // Function to hide the validation alert
            function hideValidationAlert() {
                validationAlert.style.display = 'none';
                validationMessage.innerHTML = '';
            }
            
            // Handle form submission
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Hide any previous validation messages
                hideValidationAlert();
                
                const frontFile = frontImage.files[0];
                const backFile = backImage.files[0];
                if (!frontFile || !backFile) {
                    alert('Please select both front and back images!');
                    return;
                }
                
                // Show spinner
                processSpinner.style.display = 'inline-block';
                processButtonText.textContent = 'Processing...';
                
                try {
                    let docType;
                    const outputFormat = document.getElementById('outputFormat').value;
                    
                    // Determine whether to auto-detect or use manual selection
                    if (autoDetect.checked) {
                        // First detect document type from front image
                        const detectFormData = new FormData();
                        detectFormData.append('file', frontFile);
                        
                        // Show detection status
                        processButtonText.textContent = 'Detecting document type...';
                        
                        const detectResponse = await fetch('/api/detect-document', {
                            method: 'POST',
                            body: detectFormData
                        });
                        
                        if (!detectResponse.ok) {
                            throw new Error('Failed to detect document type');
                        }
                        
                        const detectResult = await detectResponse.json();
                        docType = detectResult.documentType;
                        
                        if (docType === 'unknown') {
                            alert('Could not automatically detect document type. Please select manually.');
                            manualSelect.checked = true;
                            manualSelectionOptions.style.display = 'block';
                            processSpinner.style.display = 'none';
                            processButtonText.textContent = 'Process Document';
                            return;
                        }
                        
                        // Update status
                        processButtonText.textContent = `Processing ${docType}...`;
                    } else {
                        docType = documentType.value;
                    }
                    
                    // Create formData for processing both sides
                    const formData = new FormData();
                    formData.append('front_file', frontFile);
                    formData.append('back_file', backFile);
                    formData.append('document_type', docType);
                    formData.append('output_format', outputFormat);
                    
                    // Process both sides together
                    const response = await fetch('/api/process-document-both-sides', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        // Check if it's a validation error with specific message
                        if (response.status === 400) {
                            const errorData = await response.json();
                            if (errorData.errors && errorData.errors.length > 0) {
                                // Check for wrong order error which we can auto-correct
                                const wrongOrderError = errorData.errors.find(err => 
                                    err.includes("wrong order") || 
                                    (err.includes("front") && err.includes("back"))
                                );
                                
                                if (wrongOrderError) {
                                    // Offer to auto-swap the images
                                    const swapConfirm = confirm(
                                        "The images appear to be in the wrong order (front/back swapped). "+
                                        "Would you like to automatically swap them and continue processing?"
                                    );
                                    
                                    if (swapConfirm) {
                                        // Swap the files in the FormData
                                        formData.delete('front_file');
                                        formData.delete('back_file');
                                        formData.append('front_file', backFile);
                                        formData.append('back_file', frontFile);
                                        
                                        // Try again with swapped files
                                        const retryResponse = await fetch('/api/process-document-both-sides', {
                                            method: 'POST',
                                            body: formData
                                        });
                                        
                                        if (retryResponse.ok) {
                                            // Continue with standard processing
                                            if (outputFormat === 'json') {
                                                const result = await retryResponse.json();
                                                resultContent.textContent = JSON.stringify(result, null, 2);
                                                resultContent.style.display = 'block';
                                                
                                                // Display document info
                                                detectedDocType.textContent = docType.charAt(0).toUpperCase() + docType.slice(1);
                                                detectedDocSide.textContent = 'Front & Back (Auto-corrected)';
                                                resultInfo.style.display = 'block';
                                                noResultText.style.display = 'none';
                                                
                                                // Setup download button
                                                setupDownloadButton(result, docType);
                                            } else {
                                                handleCsvResponse(await retryResponse.blob(), docType, 'Front & Back (Auto-corrected)');
                                            }
                                            return;
                                        }
                                    }
                                }
                                
                                // Display validation errors in the alert
                                const errorMessages = errorData.errors.join('<br><br>');
                                validationMessage.innerHTML = errorMessages;
                                validationAlert.style.display = 'block';
                                
                                // Scroll to the alert
                                validationAlert.scrollIntoView({ behavior: 'smooth' });
                                return;
                            }
                        }
                        throw new Error('Failed to process document');
                    }
                    
                    // Handle different output formats
                    if (outputFormat === 'json') {
                        const result = await response.json();
                        displayJsonResult(result, docType, 'Front & Back');
                    } else if (outputFormat === 'csv') {
                        // For CSV, we'll get a file download
                        const blob = await response.blob();
                        handleCsvResponse(blob, docType, 'Front & Back');
                    }
                    
                    // Helper function to display JSON result
                    function displayJsonResult(result, docType, sideText) {
                        resultContent.textContent = JSON.stringify(result, null, 2);
                        resultContent.style.display = 'block';
                        
                        // Display document info
                        detectedDocType.textContent = docType.charAt(0).toUpperCase() + docType.slice(1);
                        detectedDocSide.textContent = sideText;
                        resultInfo.style.display = 'block';
                        noResultText.style.display = 'none';
                        
                        // Setup download button
                        setupDownloadButton(result, docType);
                    }
                    
                    // Helper function to setup download button for JSON
                    function setupDownloadButton(result, docType) {
                        downloadButton.style.display = 'block';
                        downloadButton.onclick = function() {
                            const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${docType}_complete.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        };
                    }
                    
                    // Helper function to handle CSV response
                    function handleCsvResponse(blob, docType, sideText) {
                        const url = URL.createObjectURL(blob);
                        
                        // Extract text to display in UI
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resultContent.textContent = e.target.result;
                            resultContent.style.display = 'block';
                            noResultText.style.display = 'none';
                            
                            // Display document info
                            detectedDocType.textContent = docType.charAt(0).toUpperCase() + docType.slice(1);
                            detectedDocSide.textContent = sideText;
                            resultInfo.style.display = 'block';
                        };
                        reader.readAsText(blob);
                        
                        // Auto download
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${docType}_complete.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        downloadButton.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while processing the document: ' + error.message);
                } finally {
                    // Hide spinner
                    processSpinner.style.display = 'none';
                    processButtonText.textContent = 'Process Document';
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 